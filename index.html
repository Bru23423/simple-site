<link rel="icon" href="favicon_bricklogo.png" type="image/png">
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spell Fixer v0.2</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f172a;
      --panel2:#111827;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#263244;
      --accent:#38bdf8;
      --accent2:#0ea5e9;
      --danger:#ef4444;
      --ok:#22c55e;
      --chip:#0b1220;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, Segoe UI, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1000px 500px at 15% -10%, rgba(56,189,248,.25) 0%, transparent 55%),
        radial-gradient(900px 500px at 85% 0%, rgba(34,197,94,.15) 0%, transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1100px;margin:26px auto;padding:0 16px}
    h1{margin:0 0 6px;font-size:26px}
    .sub{margin:0 0 14px;color:var(--muted);line-height:1.35}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      font-size:12px;color:var(--muted);
      border:1px solid var(--border);
      background:rgba(15,23,42,.65);
      padding:6px 10px;border-radius:999px;
      margin-bottom:10px;
    }
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(17,24,39,.92), rgba(15,23,42,.92));
      border-radius:16px;padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      min-height: 360px;
    }
    textarea{
      width:100%;
      min-height:260px;
      resize:vertical;
      padding:14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--chip);
      color:var(--text);
      font-size:16px;line-height:1.5;
      outline:none;
    }
    textarea:focus{border-color:rgba(56,189,248,.8);box-shadow:0 0 0 3px rgba(56,189,248,.18)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:1px solid var(--border);
      background:#121a2b;
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
    }
    button:hover{filter:brightness(1.08)}
    button.primary{
      border-color:rgba(56,189,248,.6);
      background:linear-gradient(180deg, var(--accent), var(--accent2));
      color:#001018;
    }
    button.danger{border-color:rgba(239,68,68,.5); background:rgba(239,68,68,.12)}
    button:disabled{opacity:.55; cursor:not-allowed}
    .status{margin-top:10px;color:var(--muted);font-size:13px}
    .status b{color:var(--text)}
    .list{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:10px}
    .issue{
      border:1px solid var(--border);
      background:rgba(11,18,32,.55);
      border-radius:14px;
      padding:10px 10px;
    }
    .top{display:flex;gap:10px;align-items:flex-start;justify-content:space-between}
    .badge{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid var(--border); color:var(--muted);
      background:rgba(15,23,42,.7);
      white-space:nowrap;
    }
    .msg{margin:0;color:var(--text);font-size:13px;line-height:1.35}
    .ctx{
      margin-top:8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px;
      color:var(--muted);
      background:rgba(0,0,0,.25);
      border:1px solid var(--border);
      padding:8px;border-radius:12px;
      overflow:auto;
    }
    .sugs{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}
    .chip{
      font-size:12px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.7);
      color:var(--text);
      padding:6px 10px;border-radius:999px;
      cursor:pointer;
    }
    .chip:hover{filter:brightness(1.1)}
    .empty{color:var(--muted);font-size:13px;line-height:1.4}
    a{color:var(--accent)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="pill">✅ LanguageTool public API • No key • Dark UI</div>
    <h1>Spell Fixer</h1>
    <p class="sub">
      Paste text → click <b>Check</b> → click a suggestion to apply it, or hit <b>Apply All</b>.
      (Uses <code>https://api.languagetool.org/v2/check</code>)
    </p>

    <div class="grid">
      <div class="card">
        <textarea id="text" spellcheck="true" placeholder="Type here..."></textarea>

        <div class="row">
          <button class="primary" id="checkBtn">Check</button>
          <button id="applyAllBtn" disabled>Apply All</button>
          <button id="copyBtn">Copy</button>
          <button class="danger" id="clearBtn">Clear</button>
        </div>

        <div class="status" id="status">Ready.</div>
      </div>

      <div class="card">
        <div class="row" style="margin-top:0">
          <button id="langAuto" class="primary">Language: Auto</button>
          <button id="langEn">en-US</button>
          <button id="langEnGb">en-GB</button>
        </div>

        <div class="status" id="meta">No results yet.</div>
        <ul class="list" id="issues"></ul>
        <p class="empty" id="empty">
          No checks yet. Tip: You can also use built-in browser spellcheck (right-click underlined words).
        </p>
      </div>
    </div>
  </div>

  <script>
    const API = "https://api.languagetool.org/v2/check";

    const elText = document.getElementById("text");
    const elIssues = document.getElementById("issues");
    const elEmpty = document.getElementById("empty");
    const elStatus = document.getElementById("status");
    const elMeta = document.getElementById("meta");

    const checkBtn = document.getElementById("checkBtn");
    const applyAllBtn = document.getElementById("applyAllBtn");
    const copyBtn = document.getElementById("copyBtn");
    const clearBtn = document.getElementById("clearBtn");

    const langAutoBtn = document.getElementById("langAuto");
    const langEnBtn = document.getElementById("langEn");
    const langEnGbBtn = document.getElementById("langEnGb");

    let language = "auto"; // "auto" or "en-US" or "en-GB"
    let lastMatches = [];

    function setLang(newLang){
      language = newLang;
      langAutoBtn.classList.toggle("primary", language === "auto");
      langEnBtn.classList.toggle("primary", language === "en-US");
      langEnGbBtn.classList.toggle("primary", language === "en-GB");
      langAutoBtn.textContent = language === "auto" ? "Language: Auto" : "Language: Auto";
      elMeta.textContent = `Language set to: ${language}`;
    }

    langAutoBtn.addEventListener("click", () => setLang("auto"));
    langEnBtn.addEventListener("click", () => setLang("en-US"));
    langEnGbBtn.addEventListener("click", () => setLang("en-GB"));

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function renderIssues(matches){
      elIssues.innerHTML = "";
      elEmpty.style.display = matches.length ? "none" : "block";
      applyAllBtn.disabled = matches.length === 0;

      matches.forEach((m, idx) => {
        const li = document.createElement("li");
        li.className = "issue";

        const msg = m.message || "Issue found";
        const short = m.shortMessage || "";
        const rule = (m.rule && m.rule.id) ? m.rule.id : "RULE";
        const offset = m.offset ?? 0;
        const length = m.length ?? 0;

        const before = elText.value.slice(Math.max(0, offset - 25), offset);
        const chunk = elText.value.slice(offset, offset + length);
        const after = elText.value.slice(offset + length, offset + length + 25);

        const replacements = (m.replacements || []).slice(0, 8);

        li.innerHTML = `
          <div class="top">
            <p class="msg"><b>${escapeHtml(short || msg)}</b><br><span style="color:var(--muted)">${escapeHtml(msg)}</span></p>
            <span class="badge">${escapeHtml(rule)}</span>
          </div>
          <div class="ctx">${escapeHtml(before)}<span style="color:var(--danger);font-weight:800">${escapeHtml(chunk || "[…]")}</span>${escapeHtml(after)}</div>
          <div class="sugs">
            ${replacements.map(r => `<span class="chip" data-i="${idx}" data-v="${escapeHtml(r.value)}">${escapeHtml(r.value)}</span>`).join("")}
          </div>
        `;

        elIssues.appendChild(li);
      });
    }

    function applyReplacement(matchIndex, value){
      const m = lastMatches[matchIndex];
      if (!m) return;

      const offset = m.offset;
      const length = m.length;

      const text = elText.value;
      elText.value = text.slice(0, offset) + value + text.slice(offset + length);
    }

    function applyAll(){
      // Applying changes shifts offsets, so apply from the end -> start
      const text = elText.value;
      const sorted = lastMatches
        .map((m, i) => ({ m, i }))
        .filter(x => x.m.replacements && x.m.replacements.length)
        .sort((a, b) => (b.m.offset - a.m.offset));

      let out = text;
      let count = 0;

      for (const item of sorted){
        const m = item.m;
        const best = m.replacements[0]?.value;
        if (!best) continue;

        const start = m.offset;
        const end = m.offset + m.length;
        out = out.slice(0, start) + best + out.slice(end);
        count++;
      }

      elText.value = out;
      elStatus.innerHTML = `Applied <b>${count}</b> fix(es). Re-check to see remaining issues.`;
    }

    document.addEventListener("click", (e) => {
      const chip = e.target.closest(".chip");
      if (!chip) return;
      const i = Number(chip.getAttribute("data-i"));
      const v = chip.getAttribute("data-v");
      // data-v was HTML-escaped in markup; reconstruct real text from textContent:
      const realValue = chip.textContent;

      // Apply the single suggestion, then re-check for accurate offsets
      applyReplacement(i, realValue);
      elStatus.innerHTML = `Applied <b>1</b> suggestion. Re-checking…`;
      checkText();
    });

    async function checkText(){
      const text = elText.value.trim();
      if (!text){
        elStatus.textContent = "Type something first.";
        elMeta.textContent = "No results.";
        lastMatches = [];
        renderIssues([]);
        return;
      }

      checkBtn.disabled = true;
      applyAllBtn.disabled = true;
      elStatus.textContent = "Checking…";

      try{
        const body = new URLSearchParams({
          text,
          language
        });

        const res = await fetch(API, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body
        });

        if (!res.ok){
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();
        const matches = Array.isArray(data.matches) ? data.matches : [];

        lastMatches = matches;

        const detected = data.language?.detectedLanguage?.name
          ? `${data.language.detectedLanguage.name} (${data.language.detectedLanguage.code})`
          : (language === "auto" ? "Unknown" : language);

        elMeta.innerHTML = `Detected: <b>${escapeHtml(detected)}</b> • Issues: <b>${matches.length}</b>`;
        elStatus.innerHTML = matches.length
          ? `Found <b>${matches.length}</b> issue(s). Click a suggestion or use Apply All.`
          : `No issues found. ✅`;

        renderIssues(matches);
      } catch (err){
        elStatus.innerHTML = `Error checking text: <b>${escapeHtml(String(err.message || err))}</b>.`;
        elMeta.textContent = "No results.";
        lastMatches = [];
        renderIssues([]);

        // Most common reason: blocked by CORS or rate limit.
        // LanguageTool usually works in browsers, but if it doesn't, you may need a tiny backend proxy.
      } finally{
        checkBtn.disabled = false;
        applyAllBtn.disabled = lastMatches.length === 0;
      }
    }

    checkBtn.addEventListener("click", checkText);
    applyAllBtn.addEventListener("click", applyAll);

    copyBtn.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(elText.value);
        elStatus.textContent = "Copied!";
      }catch{
        elStatus.textContent = "Copy blocked by browser. Use Ctrl+C.";
      }
    });

    clearBtn.addEventListener("click", () => {
      elText.value = "";
      lastMatches = [];
      renderIssues([]);
      elStatus.textContent = "Cleared.";
      elMeta.textContent = "No results.";
      elText.focus();
    });

    // Default language
    setLang("auto");
  </script>
</body>
</html>
