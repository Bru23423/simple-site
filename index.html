<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Art Gallery</title>
  <style>
    body { font-family: Arial; background: #111; color: #eee; margin: 0; }
    header, footer { background: #222; padding: 1em; text-align: center; }
    .auth { float: right; }
    .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1em; padding: 1em; }
    .card { background: #222; padding: 1em; border-radius: 10px; }
    video, img { max-width: 100%; border-radius: 10px; }
    .comment-section { margin-top: 10px; }
  </style>
</head>
<body>
  <header>
    <h1>Fan Art Gallery</h1>
    <div class="auth">
      <span id="user-info"></span>
      <button onclick="openLogin()">Login</button>
      <button onclick="logout()" id="logoutBtn" style="display:none">Logout</button>
    </div>
  </header>

  <section style="padding: 1em;">
    <input type="file" id="fileInput" accept="image/*,video/*" />
    <input type="text" id="tagsInput" placeholder="Enter tags (e.g. #fun #art)" />
    <button onclick="uploadPost()">Upload</button>
  </section>

  <section style="padding: 1em;">
    <input type="text" id="searchInput" placeholder="Search by tags..." />
    <button onclick="searchPosts()">Search</button>
  </section>

  <main class="gallery" id="gallery"></main>

  <footer>&copy; 2025 Fan Gallery</footer>

  <!-- Firebase SDK must be included separately -->

  <script>
    let currentUser = null;

    // Check for session
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById("user-info").innerText = "Hello, " + user.email;
        document.getElementById("logoutBtn").style.display = "inline";
      }
    });

    function openLogin() {
      const email = prompt("Email:");
      const password = prompt("Password:");
      firebase.auth().signInWithEmailAndPassword(email, password)
        .catch(err => {
          if (err.code === "auth/user-not-found") {
            firebase.auth().createUserWithEmailAndPassword(email, password);
          } else {
            alert(err.message);
          }
        });
    }

    function logout() {
      firebase.auth().signOut();
      location.reload();
    }

    function uploadPost() {
      if (!currentUser) return alert("Login to upload.");
      const file = document.getElementById("fileInput").files[0];
      const tags = document.getElementById("tagsInput").value;
      if (!file || !tags) return alert("Fill everything");

      const ref = firebase.storage().ref('uploads/' + Date.now() + "_" + file.name);
      ref.put(file).then(snapshot => {
        return snapshot.ref.getDownloadURL();
      }).then(url => {
        const isVideo = file.type.startsWith("video");
        firebase.database().ref("posts").push({
          url, tags, uid: currentUser.uid, email: currentUser.email, views: 0, likes: 0, type: isVideo ? "video" : "image"
        });
        document.getElementById("fileInput").value = "";
        document.getElementById("tagsInput").value = "";
      });
    }

    function loadPosts(filter = "") {
      firebase.database().ref("posts").once("value", snapshot => {
        const gallery = document.getElementById("gallery");
        gallery.innerHTML = "";
        snapshot.forEach(child => {
          const data = child.val();
          if (!filter || data.tags.includes(filter)) {
            const el = document.createElement("div");
            el.className = "card";
            el.innerHTML = `
              <strong>Posted by: ${data.email}</strong><br/>
              ${data.type === "video"
                ? `<video controls src="${data.url}"></video>`
                : `<img src="${data.url}" />`}
              <p>Tags: ${data.tags}</p>
              <p>Views: ${data.views || 0}</p>
              <p>Likes: <span id="like-${child.key}">${data.likes || 0}</span></p>
              <button onclick="likePost('${child.key}')">❤️ Like</button>
              <div class="comment-section">
                <input type="text" id="comment-${child.key}" placeholder="Comment..." />
                <button onclick="addComment('${child.key}')">Comment</button>
                <div id="comments-${child.key}"></div>
              </div>
            `;
            gallery.appendChild(el);

            firebase.database().ref(`comments/${child.key}`).on("value", snap => {
              const commentsDiv = document.getElementById(`comments-${child.key}`);
              commentsDiv.innerHTML = "";
              snap.forEach(c => {
                const comment = c.val();
                const p = document.createElement("p");
                p.innerText = `${comment.email}: ${comment.text}`;
                commentsDiv.appendChild(p);
              });
            });

            // Count views
            firebase.database().ref("posts/" + child.key + "/views").transaction(v => (v || 0) + 1);
          }
        });
      });
    }

    function likePost(postId) {
      firebase.database().ref("posts/" + postId + "/likes").transaction(l => (l || 0) + 1);
    }

    function addComment(postId) {
      const input = document.getElementById("comment-" + postId);
      const text = input.value.trim();
      if (!text || !currentUser) return;
      firebase.database().ref("comments/" + postId).push({
        text, email: currentUser.email
      });
      input.value = "";
    }

    function searchPosts() {
      const term = document.getElementById("searchInput").value;
      loadPosts(term);
    }

    loadPosts();
  </script>
</body>
</html>
